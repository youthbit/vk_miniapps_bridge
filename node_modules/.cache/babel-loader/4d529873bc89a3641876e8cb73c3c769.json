{"ast":null,"code":"import _objectSpread from \"@babel/runtime/helpers/objectSpread2\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/objectWithoutProperties\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/inherits\";\nimport _createSuper from \"@babel/runtime/helpers/createSuper\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nvar _excluded = [\"id\"];\nimport * as React from 'react';\nimport { Touch } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport { classNames } from '@vkontakte/vkjs';\nimport { setTransformStyle } from '../../lib/styles';\nimport { rubber } from '../../lib/touch';\nimport { Platform } from '../../lib/platform';\nimport { transitionEvent } from '../../lib/supportEvents';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { withContext } from '../../hoc/withContext';\nimport { ModalRootContext } from './ModalRootContext';\nimport { ConfigProviderContext, WebviewType } from '../ConfigProvider/ConfigProviderContext';\nimport { ModalType } from './types';\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from './constants';\nimport { withDOM } from '../../lib/dom';\nimport { getNavId } from '../../lib/getNavId';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { FocusTrap } from '../FocusTrap/FocusTrap';\nimport { withModalManager } from './useModalManager';\nimport { clamp } from '../../helpers/math';\nvar warn = warnOnce('ModalRoot');\nvar IS_DEV = process.env.NODE_ENV === 'development';\n\nfunction numberInRange(number, range) {\n  if (!range) {\n    return false;\n  }\n\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number) {\n  return clamp(number, 0, 98);\n}\n\nvar ModalRootTouchComponent = /*#__PURE__*/function (_React$Component) {\n  _inherits(ModalRootTouchComponent, _React$Component);\n\n  var _super = _createSuper(ModalRootTouchComponent);\n\n  function ModalRootTouchComponent(props) {\n    var _this;\n\n    _classCallCheck(this, ModalRootTouchComponent);\n\n    _this = _super.call(this, props);\n\n    _defineProperty(_assertThisInitialized(_this), \"documentScrolling\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"maskElementRef\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"viewportRef\", /*#__PURE__*/React.createRef());\n\n    _defineProperty(_assertThisInitialized(_this), \"maskAnimationFrame\", undefined);\n\n    _defineProperty(_assertThisInitialized(_this), \"modalRootContext\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"frameIds\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"restoreFocusTo\", undefined);\n\n    _defineProperty(_assertThisInitialized(_this), \"preventTouch\", function (event) {\n      if (!event) {\n        return false;\n      }\n\n      while (event.originalEvent) {\n        event = event.originalEvent;\n      }\n\n      if (event.preventDefault) {\n        event.preventDefault();\n      }\n\n      return false;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"updateModalTranslate\", function () {\n      var modalState = _this.getModalState(_this.props.activeModal);\n\n      modalState && _this.animateTranslate(modalState, modalState.translateY);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"updateModalHeight\", function () {\n      var modalState = _this.getModalState(_this.props.activeModal);\n\n      if (modalState && modalState.type === ModalType.PAGE && modalState.dynamicContentHeight) {\n        if (_this.props.enteringModal) {\n          _this.waitTransitionFinish(modalState, function () {\n            requestAnimationFrame(function () {\n              return _this.checkPageContentHeight();\n            });\n          });\n        } else {\n          requestAnimationFrame(function () {\n            return _this.checkPageContentHeight();\n          });\n        }\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onTouchMove\", function (e) {\n      if (_this.props.exitingModal) {\n        return;\n      }\n\n      var modalState = _this.getModalState(_this.props.activeModal);\n\n      if (!modalState) {\n        return;\n      }\n\n      if (modalState.type === ModalType.PAGE) {\n        return _this.onPageTouchMove(e, modalState);\n      }\n\n      if (modalState.type === ModalType.CARD) {\n        return _this.onCardTouchMove(e, modalState);\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onTouchEnd\", function (e) {\n      var modalState = _this.getModalState(_this.props.activeModal);\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE) {\n        return _this.onPageTouchEnd(e, modalState);\n      }\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.CARD) {\n        return _this.onCardTouchEnd(e, modalState);\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onScroll\", function (e) {\n      var _modalState$contentEl;\n\n      var activeModal = _this.props.activeModal;\n      var target = e.target;\n\n      if (!activeModal) {\n        return;\n      }\n\n      var modalState = _this.getModalState(activeModal);\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE && modalState !== null && modalState !== void 0 && (_modalState$contentEl = modalState.contentElement) !== null && _modalState$contentEl !== void 0 && _modalState$contentEl.contains(target)) {\n        modalState.contentScrolled = true;\n\n        if (modalState.contentScrollStopTimeout) {\n          clearTimeout(modalState.contentScrollStopTimeout);\n        }\n\n        modalState.contentScrollStopTimeout = setTimeout(function () {\n          if (modalState.contentScrolled) {\n            modalState.contentScrolled = false;\n          }\n        }, 250);\n      }\n    });\n\n    _this.state = {\n      touchDown: false,\n      dragging: false\n    };\n    _this.maskElementRef = /*#__PURE__*/React.createRef();\n    _this.modalRootContext = {\n      updateModalHeight: _this.updateModalHeight,\n      registerModal: function registerModal(_ref) {\n        var _this$getModalState;\n\n        var id = _ref.id,\n            data = _objectWithoutProperties(_ref, _excluded);\n\n        return Object.assign((_this$getModalState = _this.getModalState(id)) !== null && _this$getModalState !== void 0 ? _this$getModalState : {}, data);\n      },\n      onClose: function onClose() {\n        return _this.props.onExit();\n      },\n      isInsideModal: true\n    };\n    _this.frameIds = {};\n    return _this;\n  }\n\n  _createClass(ModalRootTouchComponent, [{\n    key: \"timeout\",\n    get: function get() {\n      return this.props.platform === Platform.IOS ? 400 : 320;\n    }\n  }, {\n    key: \"document\",\n    get: function get() {\n      return this.props.document;\n    }\n  }, {\n    key: \"window\",\n    get: function get() {\n      return this.props.window;\n    }\n  }, {\n    key: \"getModalState\",\n    value: function getModalState(id) {\n      if (!id) {\n        return undefined;\n      }\n\n      return this.props.getModalState(id);\n    }\n  }, {\n    key: \"getModals\",\n    value: function getModals() {\n      return React.Children.toArray(this.props.children);\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      // Отслеживаем изменение размеров viewport (Необходимо для iOS)\n      if (this.props.platform === Platform.IOS) {\n        var _this$window;\n\n        (_this$window = this.window) === null || _this$window === void 0 ? void 0 : _this$window.addEventListener('resize', this.updateModalTranslate, false);\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.toggleDocumentScrolling(true);\n      this.window.removeEventListener('resize', this.updateModalTranslate, false);\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      var _this2 = this; // transition phase 2: animate exiting modal\n\n\n      if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n        this.closeModal(this.props.exitingModal);\n      } // transition phase 3: animate entering modal\n\n\n      if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n        var enteringModal = this.props.enteringModal;\n        var enteringState = this.getModalState(enteringModal);\n        this.props.onEnter();\n        this.waitTransitionFinish(enteringState, function () {\n          if (enteringState !== null && enteringState !== void 0 && enteringState.innerElement) {\n            enteringState.innerElement.style.transitionDelay = '';\n          }\n\n          _this2.props.onEntered(enteringModal);\n        });\n\n        if (enteringState !== null && enteringState !== void 0 && enteringState.innerElement) {\n          enteringState.innerElement.style.transitionDelay = this.props.delayEnter ? \"\".concat(this.timeout, \"ms\") : '';\n          this.animateTranslate(enteringState, enteringState.translateY);\n        }\n      } // focus restoration\n\n\n      if (this.props.activeModal && !prevProps.activeModal) {\n        this.restoreFocusTo = this.document.activeElement;\n      }\n\n      if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n        this.restoreFocusTo.focus();\n        this.restoreFocusTo = null;\n      }\n\n      this.toggleDocumentScrolling(!this.props.activeModal && !this.props.exitingModal);\n    }\n    /* Отключает скролл документа */\n\n  }, {\n    key: \"toggleDocumentScrolling\",\n    value: function toggleDocumentScrolling(enabled) {\n      if (this.documentScrolling === enabled) {\n        return;\n      }\n\n      this.documentScrolling = enabled;\n\n      if (enabled) {\n        // Здесь нужен последний аргумент с такими же параметрами, потому что\n        // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n        // https://github.com/VKCOM/VKUI/issues/444\n        this.window.removeEventListener('touchmove', this.preventTouch, {\n          // @ts-expect-error: TS2769 В интерфейсе EventListenerOptions нет поля passive\n          passive: false\n        });\n      } else {\n        this.window.addEventListener('touchmove', this.preventTouch, {\n          passive: false\n        });\n      }\n    }\n  }, {\n    key: \"checkPageContentHeight\",\n    value: function checkPageContentHeight() {\n      var modalState = this.getModalState(this.props.activeModal);\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE && modalState !== null && modalState !== void 0 && modalState.modalElement) {\n        var prevModalState = _objectSpread({}, modalState);\n\n        initPageModal(modalState);\n\n        var currentModalState = _objectSpread({}, modalState);\n\n        var needAnimate = false;\n\n        if (prevModalState.expandable === currentModalState.expandable) {\n          if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n            needAnimate = true;\n          }\n        } else {\n          needAnimate = true;\n        }\n\n        if (needAnimate) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n      }\n    }\n  }, {\n    key: \"closeModal\",\n    value: function closeModal(id) {\n      var _this3 = this,\n          _prevModalState$trans,\n          _nextModalState$trans,\n          _nextModalState$trans2; // Сбрасываем состояния, которые могут помешать закрытию модального окна\n\n\n      this.setState({\n        touchDown: false\n      });\n      var prevModalState = this.getModalState(id);\n\n      if (!prevModalState) {\n        id && warn(\"closeActiveModal: \\u043C\\u043E\\u0434\\u0430\\u043B\\u044C\\u043D\\u043E\\u0435 \\u043E\\u043A\\u043D\\u043E (\\u0441\\u0442\\u0440\\u0430\\u043D\\u0438\\u0446\\u0430) \".concat(id, \" \\u043D\\u0435 \\u0441\\u0443\\u0449\\u0435\\u0441\\u0442\\u0432\\u0443\\u0435\\u0442\"), 'error');\n        return;\n      }\n\n      var nextModalState = this.getModalState(this.props.activeModal);\n      var nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n      var prevIsPage = !!prevModalState && prevModalState.type === ModalType.PAGE;\n      this.waitTransitionFinish(prevModalState, function () {\n        return _this3.props.onExited(id);\n      });\n      var exitTranslate = prevIsPage && nextIsPage && ((_prevModalState$trans = prevModalState.translateY) !== null && _prevModalState$trans !== void 0 ? _prevModalState$trans : 0) <= ((_nextModalState$trans = nextModalState === null || nextModalState === void 0 ? void 0 : nextModalState.translateYFrom) !== null && _nextModalState$trans !== void 0 ? _nextModalState$trans : 0) && !this.props.isBack ? ((_nextModalState$trans2 = nextModalState === null || nextModalState === void 0 ? void 0 : nextModalState.translateYFrom) !== null && _nextModalState$trans2 !== void 0 ? _nextModalState$trans2 : 0) + 10 : 100;\n      this.animateTranslate(prevModalState, exitTranslate);\n\n      if (!nextModalState) {\n        // NOTE: was only for clean exit\n        this.setMaskOpacity(prevModalState, 0);\n      }\n    }\n  }, {\n    key: \"onPageTouchMove\",\n    value: function onPageTouchMove(event, modalState) {\n      var _modalState$innerElem, _modalState$headerEle;\n\n      var shiftY = event.shiftY,\n          originalEvent = event.originalEvent;\n      var target = originalEvent.target;\n\n      if (!event.isY) {\n        var _this$viewportRef$cur;\n\n        if ((_this$viewportRef$cur = this.viewportRef.current) !== null && _this$viewportRef$cur !== void 0 && _this$viewportRef$cur.contains(target)) {\n          originalEvent.preventDefault();\n        }\n\n        return;\n      }\n\n      if (!((_modalState$innerElem = modalState.innerElement) !== null && _modalState$innerElem !== void 0 && _modalState$innerElem.contains(target))) {\n        return originalEvent.preventDefault();\n      }\n\n      originalEvent.stopPropagation();\n      var expandable = modalState.expandable,\n          contentScrolled = modalState.contentScrolled,\n          collapsed = modalState.collapsed,\n          expanded = modalState.expanded;\n\n      if (!this.state.touchDown) {\n        var _modalState$contentEl2, _modalState$contentEl3;\n\n        modalState.touchStartContentScrollTop = (_modalState$contentEl2 = (_modalState$contentEl3 = modalState.contentElement) === null || _modalState$contentEl3 === void 0 ? void 0 : _modalState$contentEl3.scrollTop) !== null && _modalState$contentEl2 !== void 0 ? _modalState$contentEl2 : 0;\n        this.setState({\n          touchDown: true\n        });\n      }\n\n      if (contentScrolled) {\n        return;\n      }\n\n      if (modalState.touchMovePositive === null) {\n        modalState.touchMovePositive = shiftY > 0;\n      }\n\n      if (!modalState.expandable || collapsed || expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0 || (_modalState$headerEle = modalState.headerElement) !== null && _modalState$headerEle !== void 0 && _modalState$headerEle.contains(target)) {\n        var _modalState$translate;\n\n        originalEvent.preventDefault();\n\n        if (!expandable && shiftY < 0 || !this.window) {\n          return;\n        }\n\n        !this.state.dragging && this.setState({\n          dragging: true\n        });\n        var shiftYPercent = shiftY / this.window.innerHeight * 100;\n        var shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform !== Platform.IOS);\n        modalState.touchShiftYPercent = shiftYPercent;\n        modalState.translateYCurrent = rangeTranslate(((_modalState$translate = modalState.translateY) !== null && _modalState$translate !== void 0 ? _modalState$translate : 0) + shiftYCurrent);\n        this.animateTranslate(modalState, modalState.translateYCurrent);\n        this.setMaskOpacity(modalState);\n      }\n    }\n  }, {\n    key: \"onCardTouchMove\",\n    value: function onCardTouchMove(event, modalState) {\n      var _modalState$innerElem2;\n\n      var originalEvent = event.originalEvent,\n          shiftY = event.shiftY;\n      var target = originalEvent.target;\n\n      if ((_modalState$innerElem2 = modalState.innerElement) !== null && _modalState$innerElem2 !== void 0 && _modalState$innerElem2.contains(target)) {\n        var _modalState$translate2;\n\n        if (!this.state.touchDown) {\n          this.setState({\n            touchDown: true,\n            dragging: true\n          });\n        }\n\n        var shiftYPercent = shiftY / modalState.innerElement.offsetHeight * 100;\n        var shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform !== Platform.IOS);\n        modalState.touchShiftYPercent = shiftYPercent;\n        modalState.translateYCurrent = Math.max(0, ((_modalState$translate2 = modalState.translateY) !== null && _modalState$translate2 !== void 0 ? _modalState$translate2 : 0) + shiftYCurrent);\n        this.animateTranslate(modalState, modalState.translateYCurrent);\n        this.setMaskOpacity(modalState);\n      }\n    }\n  }, {\n    key: \"onPageTouchEnd\",\n    value: function onPageTouchEnd(event, modalState) {\n      var _this4 = this;\n\n      var startY = event.startY,\n          shiftY = event.shiftY;\n      modalState.contentScrolled = false;\n      modalState.touchMovePositive = null;\n      var setStateCallback;\n\n      if (this.state.dragging && this.window) {\n        var _modalState$translate3, _modalState$touchShif;\n\n        var shiftYEndPercent = (startY + shiftY) / this.window.innerHeight * 100;\n        var translateY = (_modalState$translate3 = modalState.translateYCurrent) !== null && _modalState$translate3 !== void 0 ? _modalState$translate3 : 0;\n        var expectTranslateY = translateY / event.duration * 240 * 0.6 * (((_modalState$touchShif = modalState.touchShiftYPercent) !== null && _modalState$touchShif !== void 0 ? _modalState$touchShif : 0) < 0 ? -1 : 1);\n        translateY = rangeTranslate(translateY + expectTranslateY);\n\n        if (modalState.settlingHeight !== 100) {\n          if (numberInRange(translateY, modalState.expandedRange)) {\n            var _modalState$expandedR, _modalState$expandedR2;\n\n            translateY = (_modalState$expandedR = (_modalState$expandedR2 = modalState.expandedRange) === null || _modalState$expandedR2 === void 0 ? void 0 : _modalState$expandedR2[0]) !== null && _modalState$expandedR !== void 0 ? _modalState$expandedR : 0;\n          } else if (numberInRange(translateY, modalState.collapsedRange)) {\n            var _modalState$translate4;\n\n            translateY = (_modalState$translate4 = modalState.translateYFrom) !== null && _modalState$translate4 !== void 0 ? _modalState$translate4 : 0;\n          } else if (numberInRange(translateY, modalState.hiddenRange)) {\n            translateY = 100;\n          } else {\n            var _modalState$translate5;\n\n            translateY = (_modalState$translate5 = modalState.translateYFrom) !== null && _modalState$translate5 !== void 0 ? _modalState$translate5 : 0;\n          }\n        } else {\n          if (numberInRange(translateY, [0, 25])) {\n            translateY = 0;\n          } else {\n            translateY = 100;\n          }\n        }\n\n        if (translateY !== 100 && shiftYEndPercent >= 75) {\n          translateY = 100;\n        }\n\n        modalState.translateY = translateY;\n        modalState.translateYCurrent = translateY;\n        modalState.collapsed = translateY > 0 && translateY < shiftYEndPercent;\n        modalState.expanded = translateY === 0;\n        modalState.hidden = translateY === 100;\n\n        if (modalState.hidden) {\n          this.props.onExit();\n        }\n\n        setStateCallback = function setStateCallback() {\n          if (!modalState.hidden) {\n            _this4.animateTranslate(modalState, modalState.translateY);\n          }\n\n          _this4.setMaskOpacity(modalState);\n        };\n      }\n\n      this.setState({\n        touchDown: false,\n        dragging: false\n      }, setStateCallback);\n    }\n  }, {\n    key: \"onCardTouchEnd\",\n    value: function onCardTouchEnd(_ref2, modalState) {\n      var _this5 = this;\n\n      var duration = _ref2.duration;\n      var setStateCallback;\n\n      if (this.state.dragging) {\n        var _modalState$translate6, _modalState$touchShif2;\n\n        var translateY = (_modalState$translate6 = modalState.translateYCurrent) !== null && _modalState$translate6 !== void 0 ? _modalState$translate6 : 0;\n        var expectTranslateY = translateY / duration * 240 * 0.6 * (((_modalState$touchShif2 = modalState.touchShiftYPercent) !== null && _modalState$touchShif2 !== void 0 ? _modalState$touchShif2 : 0) < 0 ? -1 : 1);\n        translateY = Math.max(0, translateY + expectTranslateY);\n\n        if (translateY >= 30) {\n          translateY = 100;\n        } else {\n          translateY = 0;\n        }\n\n        modalState.translateY = translateY;\n        modalState.hidden = translateY === 100;\n\n        if (modalState.hidden) {\n          this.props.onExit();\n        }\n\n        setStateCallback = function setStateCallback() {\n          if (!modalState.hidden) {\n            _this5.animateTranslate(modalState, modalState.translateY);\n          }\n\n          _this5.setMaskOpacity(modalState);\n        };\n      }\n\n      this.setState({\n        touchDown: false,\n        dragging: false\n      }, setStateCallback);\n    }\n  }, {\n    key: \"waitTransitionFinish\",\n    value: function waitTransitionFinish(modalState, eventHandler) {\n      if (transitionEvent.supported) {\n        var _modalState$innerElem4;\n\n        var onceHandler = function onceHandler() {\n          var _modalState$innerElem3;\n\n          modalState === null || modalState === void 0 ? void 0 : (_modalState$innerElem3 = modalState.innerElement) === null || _modalState$innerElem3 === void 0 ? void 0 : _modalState$innerElem3.removeEventListener(transitionEvent.name, onceHandler);\n          eventHandler();\n        };\n\n        modalState === null || modalState === void 0 ? void 0 : (_modalState$innerElem4 = modalState.innerElement) === null || _modalState$innerElem4 === void 0 ? void 0 : _modalState$innerElem4.addEventListener(transitionEvent.name, onceHandler);\n      } else {\n        setTimeout(eventHandler, this.timeout);\n      }\n    }\n    /**\n     * Анимирует сдвиг модалки\n     *\n     * @param {ModalsStateEntry} modalState\n     * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n     */\n\n  }, {\n    key: \"animateTranslate\",\n    value: function animateTranslate(modalState, percent) {\n      var frameId = \"animateTranslateFrame\".concat(modalState.id);\n      cancelAnimationFrame(this.frameIds[frameId]);\n      this.frameIds[frameId] = requestAnimationFrame(function () {\n        setTransformStyle(modalState.innerElement, \"translate3d(0, \".concat(percent, \"%, 0)\"));\n      });\n    }\n    /* Устанавливает прозрачность для полупрозрачной подложки */\n\n  }, {\n    key: \"setMaskOpacity\",\n    value: function setMaskOpacity(modalState) {\n      var _this$props$history,\n          _this6 = this;\n\n      var forceOpacity = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n\n      if (forceOpacity === null && ((_this$props$history = this.props.history) === null || _this$props$history === void 0 ? void 0 : _this$props$history[0]) !== modalState.id) {\n        return;\n      }\n\n      if (this.maskAnimationFrame) {\n        cancelAnimationFrame(this.maskAnimationFrame);\n      }\n\n      this.maskAnimationFrame = requestAnimationFrame(function () {\n        if (_this6.maskElementRef.current) {\n          var _modalState$translate7 = modalState.translateY,\n              translateY = _modalState$translate7 === void 0 ? 0 : _modalState$translate7,\n              _modalState$translate8 = modalState.translateYCurrent,\n              translateYCurrent = _modalState$translate8 === void 0 ? 0 : _modalState$translate8;\n          var opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n          _this6.maskElementRef.current.style.opacity = clamp(opacity, 0, 100).toString();\n        }\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$props$configPro,\n          _this7 = this;\n\n      var _this$props = this.props,\n          activeModal = _this$props.activeModal,\n          exitingModal = _this$props.exitingModal,\n          enteringModal = _this$props.enteringModal;\n      var _this$state = this.state,\n          touchDown = _this$state.touchDown,\n          dragging = _this$state.dragging;\n\n      if (!activeModal && !exitingModal) {\n        return null;\n      }\n\n      return /*#__PURE__*/React.createElement(TouchRootContext.Provider, {\n        value: true\n      }, /*#__PURE__*/React.createElement(ModalRootContext.Provider, {\n        value: this.modalRootContext\n      }, /*#__PURE__*/React.createElement(Touch, {\n        className: classNames(\"vkuiModalRoot\", ((_this$props$configPro = this.props.configProvider) === null || _this$props$configPro === void 0 ? void 0 : _this$props$configPro.webviewType) === WebviewType.VKAPPS && \"vkuiModalRoot--vkapps\", touchDown && \"vkuiModalRoot--touched\", !!(enteringModal || exitingModal) && \"vkuiModalRoot--switching\"),\n        onMove: this.onTouchMove,\n        onEnd: this.onTouchEnd,\n        onScroll: this.onScroll\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"vkuiModalRoot__mask\",\n        onClick: this.props.onExit,\n        ref: this.maskElementRef\n      }), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"vkuiModalRoot__viewport\",\n        ref: this.viewportRef\n      }, this.getModals().map(function (Modal) {\n        var modalId = getNavId(Modal.props, warn);\n\n        var _modalState = _this7.getModalState(modalId);\n\n        if (modalId !== activeModal && modalId !== exitingModal || !_modalState) {\n          return null;\n        }\n\n        var modalState = _objectSpread({}, _modalState);\n\n        var isPage = modalState.type === ModalType.PAGE;\n        var key = \"modal-\".concat(modalId);\n        return /*#__PURE__*/React.createElement(FocusTrap, {\n          key: key,\n          getRootRef: function getRootRef(e) {\n            var modalState = _this7.getModalState(modalId);\n\n            if (modalState) {\n              modalState.modalElement = e;\n            }\n          },\n          onClose: _this7.props.onExit,\n          timeout: _this7.timeout,\n          className: classNames(\"vkuiModalRoot__modal\", dragging && \"vkuiModalRoot__modal--dragging\", isPage && modalState.expandable && \"vkuiModalRoot__modal--expandable\", isPage && modalState.collapsed && \"vkuiModalRoot__modal--collapsed\"),\n          restoreFocus: false\n        }, Modal);\n      })))));\n    }\n  }]);\n\n  return ModalRootTouchComponent;\n}(React.Component);\n\nexport var ModalRootTouch = withContext(withPlatform(withDOM(withModalManager(initModal)(ModalRootTouchComponent))), ConfigProviderContext, 'configProvider');\n/**\n * Инициализирует модалку перед анимацией открытия\n */\n\nfunction initModal(modalState) {\n  switch (modalState.type) {\n    case ModalType.PAGE:\n      modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n      return initPageModal(modalState);\n\n    case ModalType.CARD:\n      return initCardModal(modalState);\n\n    default:\n      IS_DEV && warn(\"initActiveModal: modalState.type=\\\"\".concat(modalState.type, \"\\\" \\u043D\\u0435 \\u043F\\u043E\\u0434\\u0434\\u0435\\u0440\\u0436\\u0438\\u0432\\u0430\\u0435\\u0442\\u0441\\u044F\"), 'error');\n  }\n}\n\nfunction initPageModal(modalState) {\n  var _contentElement$clien;\n\n  var contentElement = modalState.contentElement;\n  var contentHeight = (contentElement === null || contentElement === void 0 ? void 0 : contentElement.firstElementChild).offsetHeight;\n  var prevTranslateY = modalState.translateY;\n  modalState.expandable = contentHeight > ((_contentElement$clien = contentElement === null || contentElement === void 0 ? void 0 : contentElement.clientHeight) !== null && _contentElement$clien !== void 0 ? _contentElement$clien : 0) || modalState.settlingHeight === 100;\n  var collapsed = false;\n  var expanded = false;\n  var translateYFrom;\n  var translateY;\n  var expandedRange;\n  var collapsedRange;\n  var hiddenRange;\n\n  if (modalState.expandable) {\n    var _modalState$settlingH;\n\n    translateYFrom = 100 - ((_modalState$settlingH = modalState.settlingHeight) !== null && _modalState$settlingH !== void 0 ? _modalState$settlingH : 0);\n    var shiftHalf = translateYFrom / 2;\n    var visiblePart = 100 - translateYFrom;\n    expandedRange = [0, shiftHalf];\n    collapsedRange = [shiftHalf, translateYFrom + visiblePart / 4];\n    hiddenRange = [translateYFrom + visiblePart / 4, 100];\n    collapsed = translateYFrom > 0;\n    expanded = translateYFrom <= 0;\n    translateY = translateYFrom;\n  } else {\n    var _modalState$headerEle2, _modalState$headerEle3, _modalState$innerElem5, _modalState$innerElem6, _modalState$innerElem7;\n\n    var headerHeight = (_modalState$headerEle2 = (_modalState$headerEle3 = modalState.headerElement) === null || _modalState$headerEle3 === void 0 ? void 0 : _modalState$headerEle3.offsetHeight) !== null && _modalState$headerEle2 !== void 0 ? _modalState$headerEle2 : 0;\n    var height = contentHeight + headerHeight;\n    translateYFrom = 100 - height / ((_modalState$innerElem5 = (_modalState$innerElem6 = modalState.innerElement) === null || _modalState$innerElem6 === void 0 ? void 0 : (_modalState$innerElem7 = _modalState$innerElem6.parentElement) === null || _modalState$innerElem7 === void 0 ? void 0 : _modalState$innerElem7.offsetHeight) !== null && _modalState$innerElem5 !== void 0 ? _modalState$innerElem5 : 0) * 100;\n    translateY = translateYFrom;\n    expandedRange = [translateY, translateY + 25];\n    collapsedRange = [translateY + 25, translateY + 25];\n    hiddenRange = [translateY + 25, translateY + 100];\n  } // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n\n\n  if (modalState.expandable && translateY > (prevTranslateY !== null && prevTranslateY !== void 0 ? prevTranslateY : 100) || modalState.settlingHeight === 100) {\n    translateY = 0;\n  } // Если модалка уже раскрыта обновляем состояния\n\n\n  if (translateY === 0) {\n    expanded = true;\n    collapsed = false;\n  }\n\n  modalState.expandedRange = expandedRange;\n  modalState.collapsedRange = collapsedRange;\n  modalState.hiddenRange = hiddenRange;\n  modalState.translateY = translateY;\n  modalState.translateYFrom = translateYFrom;\n  modalState.collapsed = collapsed;\n  modalState.expanded = expanded;\n}\n\nfunction initCardModal(modalState) {\n  modalState.translateY = 0;\n}","map":{"version":3,"mappings":"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","names":["React","Touch","TouchRootContext","classNames","setTransformStyle","rubber","Platform","transitionEvent","withPlatform","withContext","ModalRootContext","ConfigProviderContext","WebviewType","ModalType","MODAL_PAGE_DEFAULT_PERCENT_HEIGHT","withDOM","getNavId","warnOnce","FocusTrap","withModalManager","clamp","warn","IS_DEV","process","env","NODE_ENV","numberInRange","number","range","rangeTranslate","ModalRootTouchComponent","_inherits","props","_classCallCheck","_this","_defineProperty","createRef","undefined","event","originalEvent","preventDefault","modalState","getModalState","activeModal","animateTranslate","translateY","type","PAGE","dynamicContentHeight","enteringModal","waitTransitionFinish","requestAnimationFrame","checkPageContentHeight","e","exitingModal","onPageTouchMove","CARD","onCardTouchMove","onPageTouchEnd","onCardTouchEnd","target","contentElement","_modalState$contentEl","contains","contentScrolled","contentScrollStopTimeout","clearTimeout","setTimeout","state","touchDown","dragging","maskElementRef","modalRootContext","updateModalHeight","registerModal","id","data","Object","assign","_this$getModalState","onClose","onExit","isInsideModal","frameIds","_createClass","key","get","platform","IOS","document","window","value","Children","toArray","children","_this$window","addEventListener","updateModalTranslate","toggleDocumentScrolling","removeEventListener","prevProps","closeModal","enteringState","onEnter","innerElement","style","transitionDelay","_this2","onEntered","delayEnter","timeout","restoreFocusTo","activeElement","focus","enabled","documentScrolling","preventTouch","passive","modalElement","prevModalState","initPageModal","currentModalState","needAnimate","expandable","translateYFrom","setState","nextModalState","nextIsPage","prevIsPage","_this3","onExited","exitTranslate","_prevModalState$trans","_nextModalState$trans","isBack","_nextModalState$trans2","setMaskOpacity","shiftY","isY","viewportRef","current","_this$viewportRef$cur","_modalState$innerElem","stopPropagation","collapsed","expanded","touchStartContentScrollTop","_modalState$contentEl3","scrollTop","_modalState$contentEl2","touchMovePositive","headerElement","_modalState$headerEle","shiftYPercent","innerHeight","shiftYCurrent","touchShiftYPercent","translateYCurrent","_modalState$translate","_modalState$innerElem2","offsetHeight","Math","max","_modalState$translate2","startY","setStateCallback","shiftYEndPercent","_modalState$translate3","expectTranslateY","duration","_modalState$touchShif","settlingHeight","expandedRange","_modalState$expandedR2","_modalState$expandedR","collapsedRange","_modalState$translate4","hiddenRange","_modalState$translate5","hidden","_this4","_modalState$translate6","_modalState$touchShif2","_this5","eventHandler","supported","onceHandler","_modalState$innerElem3","name","_modalState$innerElem4","percent","frameId","cancelAnimationFrame","forceOpacity","history","_this$props$history","maskAnimationFrame","_this6","_modalState$translate7","_modalState$translate8","opacity","toString","Provider","className","configProvider","_this$props$configPro","webviewType","VKAPPS","onMove","onTouchMove","onEnd","onTouchEnd","onScroll","onClick","ref","getModals","map","Modal","modalId","_modalState","_this7","isPage","getRootRef","restoreFocus","Component","ModalRootTouch","initModal","initCardModal","contentHeight","firstElementChild","prevTranslateY","clientHeight","_contentElement$clien","_modalState$settlingH","shiftHalf","visiblePart","headerHeight","_modalState$headerEle3","_modalState$headerEle2","height","_modalState$innerElem6","parentElement","_modalState$innerElem7","_modalState$innerElem5"],"sources":["/Users/pitus_anonimous/Desktop/youth_bit_hack/youth_bit_vk/node_modules/@vkontakte/vkui/src/components/ModalRoot/ModalRoot.tsx"],"sourcesContent":["import * as React from 'react';\nimport { Touch, TouchEvent } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport { classNames } from '@vkontakte/vkjs';\nimport { setTransformStyle } from '../../lib/styles';\nimport { rubber } from '../../lib/touch';\nimport { Platform } from '../../lib/platform';\nimport { transitionEvent } from '../../lib/supportEvents';\nimport { HasPlatform } from '../../types';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { withContext } from '../../hoc/withContext';\nimport { ModalRootContext, ModalRootContextInterface } from './ModalRootContext';\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n  WebviewType,\n} from '../ConfigProvider/ConfigProviderContext';\nimport { ModalsStateEntry, ModalType, TranslateRange } from './types';\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from './constants';\nimport { DOMProps, withDOM } from '../../lib/dom';\nimport { getNavId } from '../../lib/getNavId';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { FocusTrap } from '../FocusTrap/FocusTrap';\nimport { ModalTransitionProps, withModalManager } from './useModalManager';\nimport { clamp } from '../../helpers/math';\nimport styles from './ModalRoot.module.css';\n\nconst warn = warnOnce('ModalRoot');\nconst IS_DEV = process.env.NODE_ENV === 'development';\n\nfunction numberInRange(number: number, range: TranslateRange | undefined) {\n  if (!range) {\n    return false;\n  }\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number: number) {\n  return clamp(number, 0, 98);\n}\n\nexport interface ModalRootProps extends HasPlatform {\n  activeModal?: string | null;\n\n  /**\n   * Будет вызвано при начале открытия активной модалки с её id\n   */\n  onOpen?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном открытии активной модалки с её id\n   */\n  onOpened?(modalId: string): void;\n\n  /**\n   * Будет вызвано при начале закрытия активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном закрытии активной модалки с её id\n   */\n  onClosed?(modalId: string): void;\n\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n  children?: React.ReactNode;\n}\n\ninterface ModalRootState {\n  touchDown?: boolean;\n  dragging?: boolean;\n}\n\nclass ModalRootTouchComponent extends React.Component<\n  ModalRootProps & DOMProps & ModalTransitionProps,\n  ModalRootState\n> {\n  constructor(props: ModalRootProps & ModalTransitionProps) {\n    super(props);\n    this.state = {\n      touchDown: false,\n      dragging: false,\n    };\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: this.updateModalHeight,\n      registerModal: ({ id, ...data }) => Object.assign(this.getModalState(id) ?? {}, data),\n      onClose: () => this.props.onExit(),\n      isInsideModal: true,\n    };\n\n    this.frameIds = {};\n  }\n\n  private documentScrolling = false;\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private readonly viewportRef = React.createRef<HTMLDivElement>();\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private readonly frameIds: {\n    [index: string]: number;\n  };\n  private restoreFocusTo: HTMLElement | undefined | null = undefined;\n\n  get timeout(): number {\n    return this.props.platform === Platform.IOS ? 400 : 320;\n  }\n\n  get document() {\n    return this.props.document;\n  }\n\n  get window() {\n    return this.props.window;\n  }\n\n  getModalState(id: string | undefined | null) {\n    if (!id) {\n      return undefined;\n    }\n    return this.props.getModalState(id);\n  }\n\n  getModals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  componentDidMount() {\n    // Отслеживаем изменение размеров viewport (Необходимо для iOS)\n    if (this.props.platform === Platform.IOS) {\n      this.window?.addEventListener('resize', this.updateModalTranslate, false);\n    }\n  }\n\n  componentWillUnmount() {\n    this.toggleDocumentScrolling(true);\n    this.window!.removeEventListener('resize', this.updateModalTranslate, false);\n  }\n\n  componentDidUpdate(prevProps: ModalRootProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n      const { enteringModal } = this.props;\n      const enteringState = this.getModalState(enteringModal);\n      this.props.onEnter();\n      this.waitTransitionFinish(enteringState, () => {\n        if (enteringState?.innerElement) {\n          enteringState.innerElement.style.transitionDelay = '';\n        }\n        this.props.onEntered(enteringModal);\n      });\n\n      if (enteringState?.innerElement) {\n        enteringState.innerElement.style.transitionDelay = this.props.delayEnter\n          ? `${this.timeout}ms`\n          : '';\n        this.animateTranslate(enteringState, enteringState.translateY);\n      }\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = this.document!.activeElement as HTMLElement;\n    }\n    if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = null;\n    }\n\n    this.toggleDocumentScrolling(!this.props.activeModal && !this.props.exitingModal);\n  }\n\n  /* Отключает скролл документа */\n  toggleDocumentScrolling(enabled: boolean) {\n    if (this.documentScrolling === enabled) {\n      return;\n    }\n    this.documentScrolling = enabled;\n\n    if (enabled) {\n      // Здесь нужен последний аргумент с такими же параметрами, потому что\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      this.window!.removeEventListener('touchmove', this.preventTouch, {\n        // @ts-expect-error: TS2769 В интерфейсе EventListenerOptions нет поля passive\n        passive: false,\n      });\n    } else {\n      this.window!.addEventListener('touchmove', this.preventTouch, {\n        passive: false,\n      });\n    }\n  }\n\n  preventTouch = (event: any) => {\n    if (!event) {\n      return false;\n    }\n    while (event.originalEvent) {\n      event = event.originalEvent;\n    }\n    if (event.preventDefault) {\n      event.preventDefault();\n    }\n    return false;\n  };\n\n  updateModalTranslate = () => {\n    const modalState = this.getModalState(this.props.activeModal);\n    modalState && this.animateTranslate(modalState, modalState.translateY);\n  };\n\n  checkPageContentHeight() {\n    const modalState = this.getModalState(this.props.activeModal);\n\n    if (modalState?.type === ModalType.PAGE && modalState?.modalElement) {\n      const prevModalState = { ...modalState };\n      initPageModal(modalState);\n      const currentModalState = { ...modalState };\n\n      let needAnimate = false;\n\n      if (prevModalState.expandable === currentModalState.expandable) {\n        if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n          needAnimate = true;\n        }\n      } else {\n        needAnimate = true;\n      }\n\n      if (needAnimate) {\n        this.animateTranslate(modalState, modalState.translateY);\n      }\n    }\n  }\n\n  updateModalHeight = () => {\n    const modalState = this.getModalState(this.props.activeModal);\n\n    if (modalState && modalState.type === ModalType.PAGE && modalState.dynamicContentHeight) {\n      if (this.props.enteringModal) {\n        this.waitTransitionFinish(modalState, () => {\n          requestAnimationFrame(() => this.checkPageContentHeight());\n        });\n      } else {\n        requestAnimationFrame(() => this.checkPageContentHeight());\n      }\n    }\n  };\n\n  closeModal(id: string) {\n    // Сбрасываем состояния, которые могут помешать закрытию модального окна\n    this.setState({ touchDown: false });\n\n    const prevModalState = this.getModalState(id);\n\n    if (!prevModalState) {\n      id && warn(`closeActiveModal: модальное окно (страница) ${id} не существует`, 'error');\n      return;\n    }\n\n    const nextModalState = this.getModalState(this.props.activeModal);\n    const nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n\n    const prevIsPage = !!prevModalState && prevModalState.type === ModalType.PAGE;\n    this.waitTransitionFinish(prevModalState, () => this.props.onExited(id));\n    const exitTranslate =\n      prevIsPage &&\n      nextIsPage &&\n      (prevModalState.translateY ?? 0) <= (nextModalState?.translateYFrom ?? 0) &&\n      !this.props.isBack\n        ? (nextModalState?.translateYFrom ?? 0) + 10\n        : 100;\n    this.animateTranslate(prevModalState, exitTranslate);\n\n    if (!nextModalState) {\n      // NOTE: was only for clean exit\n      this.setMaskOpacity(prevModalState, 0);\n    }\n  }\n\n  onTouchMove = (e: TouchEvent) => {\n    if (this.props.exitingModal) {\n      return;\n    }\n    const modalState = this.getModalState(this.props.activeModal);\n    if (!modalState) {\n      return;\n    }\n\n    if (modalState.type === ModalType.PAGE) {\n      return this.onPageTouchMove(e, modalState);\n    }\n\n    if (modalState.type === ModalType.CARD) {\n      return this.onCardTouchMove(e, modalState);\n    }\n  };\n\n  onPageTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { shiftY, originalEvent } = event;\n    const target = originalEvent.target as HTMLElement;\n\n    if (!event.isY) {\n      if (this.viewportRef.current?.contains(target)) {\n        originalEvent.preventDefault();\n      }\n      return;\n    }\n\n    if (!modalState.innerElement?.contains(target)) {\n      return originalEvent.preventDefault();\n    }\n\n    originalEvent.stopPropagation();\n\n    const { expandable, contentScrolled, collapsed, expanded } = modalState;\n\n    if (!this.state.touchDown) {\n      modalState.touchStartContentScrollTop = modalState.contentElement?.scrollTop ?? 0;\n      this.setState({ touchDown: true });\n    }\n\n    if (contentScrolled) {\n      return;\n    }\n\n    if (modalState.touchMovePositive === null) {\n      modalState.touchMovePositive = shiftY > 0;\n    }\n\n    if (\n      !modalState.expandable ||\n      collapsed ||\n      (expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0) ||\n      modalState.headerElement?.contains(target)\n    ) {\n      originalEvent.preventDefault();\n\n      if ((!expandable && shiftY < 0) || !this.window) {\n        return;\n      }\n\n      !this.state.dragging && this.setState({ dragging: true });\n\n      const shiftYPercent = (shiftY / this.window.innerHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform !== Platform.IOS);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = rangeTranslate((modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onCardTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { originalEvent, shiftY } = event;\n    const target = originalEvent.target as HTMLElement;\n    if (modalState.innerElement?.contains(target)) {\n      if (!this.state.touchDown) {\n        this.setState({ touchDown: true, dragging: true });\n      }\n\n      const shiftYPercent = (shiftY / modalState.innerElement.offsetHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform !== Platform.IOS);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = Math.max(0, (modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onTouchEnd = (e: TouchEvent) => {\n    const modalState = this.getModalState(this.props.activeModal);\n\n    if (modalState?.type === ModalType.PAGE) {\n      return this.onPageTouchEnd(e, modalState);\n    }\n\n    if (modalState?.type === ModalType.CARD) {\n      return this.onCardTouchEnd(e, modalState);\n    }\n  };\n\n  onPageTouchEnd(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { startY, shiftY } = event;\n\n    modalState.contentScrolled = false;\n    modalState.touchMovePositive = null;\n\n    let setStateCallback;\n\n    if (this.state.dragging && this.window) {\n      const shiftYEndPercent = ((startY + shiftY) / this.window.innerHeight) * 100;\n\n      let translateY = modalState.translateYCurrent ?? 0;\n      const expectTranslateY =\n        (translateY / event.duration) *\n        240 *\n        0.6 *\n        ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = rangeTranslate(translateY + expectTranslateY);\n\n      if (modalState.settlingHeight !== 100) {\n        if (numberInRange(translateY, modalState.expandedRange)) {\n          translateY = modalState.expandedRange?.[0] ?? 0;\n        } else if (numberInRange(translateY, modalState.collapsedRange)) {\n          translateY = modalState.translateYFrom ?? 0;\n        } else if (numberInRange(translateY, modalState.hiddenRange)) {\n          translateY = 100;\n        } else {\n          translateY = modalState.translateYFrom ?? 0;\n        }\n      } else {\n        if (numberInRange(translateY, [0, 25])) {\n          translateY = 0;\n        } else {\n          translateY = 100;\n        }\n      }\n\n      if (translateY !== 100 && shiftYEndPercent >= 75) {\n        translateY = 100;\n      }\n\n      modalState.translateY = translateY;\n      modalState.translateYCurrent = translateY;\n      modalState.collapsed = translateY > 0 && translateY < shiftYEndPercent;\n      modalState.expanded = translateY === 0;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onCardTouchEnd({ duration }: TouchEvent, modalState: ModalsStateEntry) {\n    let setStateCallback;\n\n    if (this.state.dragging) {\n      let translateY = modalState.translateYCurrent ?? 0;\n\n      const expectTranslateY =\n        (translateY / duration) * 240 * 0.6 * ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = Math.max(0, translateY + expectTranslateY);\n\n      if (translateY >= 30) {\n        translateY = 100;\n      } else {\n        translateY = 0;\n      }\n\n      modalState.translateY = translateY;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onScroll = (e: React.SyntheticEvent) => {\n    const activeModal = this.props.activeModal;\n\n    const target = e.target as HTMLElement;\n\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.getModalState(activeModal);\n    if (modalState?.type === ModalType.PAGE && modalState?.contentElement?.contains(target)) {\n      modalState.contentScrolled = true;\n\n      if (modalState.contentScrollStopTimeout) {\n        clearTimeout(modalState.contentScrollStopTimeout);\n      }\n\n      modalState.contentScrollStopTimeout = setTimeout(() => {\n        if (modalState.contentScrolled) {\n          modalState.contentScrolled = false;\n        }\n      }, 250);\n    }\n  };\n\n  waitTransitionFinish(modalState: ModalsStateEntry | undefined, eventHandler: () => void) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(transitionEvent.name as string, onceHandler);\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(transitionEvent.name as string, onceHandler);\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /**\n   * Анимирует сдвиг модалки\n   *\n   * @param {ModalsStateEntry} modalState\n   * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n   */\n  animateTranslate(modalState: ModalsStateEntry, percent: number | undefined) {\n    const frameId = `animateTranslateFrame${modalState.id}`;\n\n    cancelAnimationFrame(this.frameIds[frameId]);\n\n    this.frameIds[frameId] = requestAnimationFrame(() => {\n      setTransformStyle(modalState.innerElement, `translate3d(0, ${percent}%, 0)`);\n    });\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number | null = null) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = clamp(opacity, 0, 100).toString();\n      }\n    });\n  }\n\n  render() {\n    const { activeModal, exitingModal, enteringModal } = this.props;\n    const { touchDown, dragging } = this.state;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <ModalRootContext.Provider value={this.modalRootContext}>\n          <Touch\n            className={classNames(\n              styles['ModalRoot'],\n              this.props.configProvider?.webviewType === WebviewType.VKAPPS &&\n                styles['ModalRoot--vkapps'],\n              touchDown && styles['ModalRoot--touched'],\n              !!(enteringModal || exitingModal) && styles['ModalRoot--switching'],\n            )}\n            onMove={this.onTouchMove}\n            onEnd={this.onTouchEnd}\n            onScroll={this.onScroll}\n          >\n            <div\n              className={styles['ModalRoot__mask']}\n              onClick={this.props.onExit}\n              ref={this.maskElementRef}\n            />\n            <div className={styles['ModalRoot__viewport']} ref={this.viewportRef}>\n              {this.getModals().map((Modal) => {\n                const modalId = getNavId(Modal.props, warn);\n                const _modalState = this.getModalState(modalId);\n                if ((modalId !== activeModal && modalId !== exitingModal) || !_modalState) {\n                  return null;\n                }\n                const modalState = { ..._modalState };\n\n                const isPage = modalState.type === ModalType.PAGE;\n                const key = `modal-${modalId}`;\n\n                return (\n                  <FocusTrap\n                    key={key}\n                    getRootRef={(e) => {\n                      const modalState = this.getModalState(modalId);\n                      if (modalState) {\n                        modalState.modalElement = e;\n                      }\n                    }}\n                    onClose={this.props.onExit}\n                    timeout={this.timeout}\n                    className={classNames(\n                      styles['ModalRoot__modal'],\n\n                      dragging && styles['ModalRoot__modal--dragging'],\n\n                      isPage && modalState.expandable && styles['ModalRoot__modal--expandable'],\n                      isPage && modalState.collapsed && styles['ModalRoot__modal--collapsed'],\n                    )}\n                    restoreFocus={false}\n                  >\n                    {Modal}\n                  </FocusTrap>\n                );\n              })}\n            </div>\n          </Touch>\n        </ModalRootContext.Provider>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootTouch = withContext(\n  withPlatform(withDOM<ModalRootProps>(withModalManager(initModal)(ModalRootTouchComponent))),\n  ConfigProviderContext,\n  'configProvider',\n);\n\n/**\n * Инициализирует модалку перед анимацией открытия\n */\nfunction initModal(modalState: ModalsStateEntry) {\n  switch (modalState.type) {\n    case ModalType.PAGE:\n      modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n      return initPageModal(modalState);\n    case ModalType.CARD:\n      return initCardModal(modalState);\n    default:\n      IS_DEV &&\n        warn(`initActiveModal: modalState.type=\"${modalState.type}\" не поддерживается`, 'error');\n  }\n}\n\nfunction initPageModal(modalState: ModalsStateEntry) {\n  const { contentElement } = modalState;\n  const contentHeight = (contentElement?.firstElementChild as HTMLElement).offsetHeight;\n\n  let prevTranslateY = modalState.translateY;\n\n  modalState.expandable =\n    contentHeight > (contentElement?.clientHeight ?? 0) || modalState.settlingHeight === 100;\n\n  let collapsed = false;\n  let expanded = false;\n  let translateYFrom;\n  let translateY;\n  let expandedRange: TranslateRange;\n  let collapsedRange: TranslateRange;\n  let hiddenRange: TranslateRange;\n\n  if (modalState.expandable) {\n    translateYFrom = 100 - (modalState.settlingHeight ?? 0);\n\n    const shiftHalf = translateYFrom / 2;\n    const visiblePart = 100 - translateYFrom;\n\n    expandedRange = [0, shiftHalf];\n    collapsedRange = [shiftHalf, translateYFrom + visiblePart / 4];\n    hiddenRange = [translateYFrom + visiblePart / 4, 100];\n\n    collapsed = translateYFrom > 0;\n    expanded = translateYFrom <= 0;\n    translateY = translateYFrom;\n  } else {\n    const headerHeight = modalState.headerElement?.offsetHeight ?? 0;\n    const height = contentHeight + headerHeight;\n\n    translateYFrom =\n      100 - (height / (modalState.innerElement?.parentElement?.offsetHeight ?? 0)) * 100;\n    translateY = translateYFrom;\n\n    expandedRange = [translateY, translateY + 25];\n    collapsedRange = [translateY + 25, translateY + 25];\n    hiddenRange = [translateY + 25, translateY + 100];\n  }\n\n  // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n  if (\n    (modalState.expandable && translateY > (prevTranslateY ?? 100)) ||\n    modalState.settlingHeight === 100\n  ) {\n    translateY = 0;\n  }\n\n  // Если модалка уже раскрыта обновляем состояния\n  if (translateY === 0) {\n    expanded = true;\n    collapsed = false;\n  }\n\n  modalState.expandedRange = expandedRange;\n  modalState.collapsedRange = collapsedRange;\n  modalState.hiddenRange = hiddenRange;\n  modalState.translateY = translateY;\n  modalState.translateYFrom = translateYFrom;\n  modalState.collapsed = collapsed;\n  modalState.expanded = expanded;\n}\n\nfunction initCardModal(modalState: ModalsStateEntry) {\n  modalState.translateY = 0;\n}\n"]},"metadata":{},"sourceType":"module"}