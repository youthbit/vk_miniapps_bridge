{"version":3,"file":"FocusTrap.js","names":["FOCUSABLE_ELEMENTS","FOCUSABLE_ELEMENTS_LIST","join","FocusTrap","Component","onClose","restoreFocus","timeout","getRootRef","children","restProps","ref","useExternRef","useDOM","document","window","React","useState","focusableNodes","setFocusableNodes","restoreFocusTo","setRestoreFocusTo","useContext","AppRootContext","keyboardInput","focusOnTrapMount","useTimeout","current","contains","activeElement","length","focus","useIsomorphicLayoutEffect","set","nodes","Array","prototype","forEach","call","querySelectorAll","focusableEl","getComputedStyle","display","visibility","push","focusOnTrapUnmount","onDocumentKeydown","e","pressedKey","Keys","TAB","lastIdx","targetIdx","findIndex","node","target","shouldFocusFirstNode","shiftKey","preventDefault","ESCAPE","useGlobalEventListener","capture"],"sources":["../../../../src/components/FocusTrap/FocusTrap.tsx"],"sourcesContent":["import * as React from 'react';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport { useGlobalEventListener } from '../../hooks/useGlobalEventListener';\nimport { useTimeout } from '../../hooks/useTimeout';\nimport { FOCUSABLE_ELEMENTS_LIST, Keys, pressedKey } from '../../lib/accessibility';\nimport { useDOM } from '../../lib/dom';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { HasComponent, HasRootRef } from '../../types';\nimport { AppRootContext } from '../AppRoot/AppRootContext';\n\nconst FOCUSABLE_ELEMENTS: string = FOCUSABLE_ELEMENTS_LIST.join();\nexport interface FocusTrapProps\n  extends React.AllHTMLAttributes<HTMLElement>,\n    HasRootRef<HTMLElement>,\n    HasComponent {\n  restoreFocus?: boolean;\n  timeout?: number;\n  onClose?(): void;\n}\n\n/**\n * @see https://vkcom.github.io/VKUI/#/FocusTrap\n */\nexport const FocusTrap = ({\n  Component = 'div',\n  onClose,\n  restoreFocus = true,\n  timeout = 0,\n  getRootRef,\n  children,\n  ...restProps\n}: FocusTrapProps) => {\n  const ref = useExternRef<HTMLElement>(getRootRef);\n\n  const { document, window } = useDOM();\n\n  const [focusableNodes, setFocusableNodes] = React.useState<HTMLElement[] | null>(null);\n  const [restoreFocusTo, setRestoreFocusTo] = React.useState<HTMLElement | null>(null);\n\n  // HANDLE TRAP MOUNT\n\n  const { keyboardInput } = React.useContext(AppRootContext);\n  const focusOnTrapMount = useTimeout(() => {\n    if (\n      keyboardInput &&\n      !ref.current?.contains(document!.activeElement) &&\n      focusableNodes?.length\n    ) {\n      focusableNodes[0].focus();\n    }\n  }, timeout);\n  useIsomorphicLayoutEffect(() => {\n    focusOnTrapMount.set();\n  }, []);\n\n  // HANDLE FOCUSABLE NODES\n\n  useIsomorphicLayoutEffect(() => {\n    if (!ref.current) {\n      return;\n    }\n\n    const nodes: HTMLElement[] = [];\n    Array.prototype.forEach.call(\n      // eslint-disable-next-line no-restricted-properties\n      ref.current.querySelectorAll(FOCUSABLE_ELEMENTS),\n      (focusableEl: Element) => {\n        const { display, visibility } = window!.getComputedStyle(focusableEl);\n\n        if (display !== 'none' && visibility !== 'hidden') {\n          nodes.push(focusableEl as HTMLElement);\n        }\n      },\n    );\n\n    if (nodes.length === 0) {\n      // Чтобы фокус был хотя бы на родителе\n      nodes.push(ref.current);\n    }\n\n    setFocusableNodes(nodes);\n  }, [children]);\n\n  // HANDLE TRAP UNMOUNT\n\n  const focusOnTrapUnmount = useTimeout(() => {\n    if (restoreFocusTo) {\n      restoreFocusTo.focus();\n    }\n  }, timeout);\n  useIsomorphicLayoutEffect(() => {\n    if (restoreFocus && document!.activeElement) {\n      setRestoreFocusTo(document!.activeElement as HTMLElement);\n\n      return () => {\n        focusOnTrapUnmount.set();\n      };\n    }\n\n    return;\n  }, [restoreFocus]);\n\n  const onDocumentKeydown = (e: KeyboardEvent) => {\n    if (pressedKey(e) === Keys.TAB && focusableNodes?.length) {\n      const lastIdx = focusableNodes.length - 1;\n      const targetIdx = focusableNodes.findIndex((node) => node === e.target);\n\n      const shouldFocusFirstNode = targetIdx === -1 || (targetIdx === lastIdx && !e.shiftKey);\n\n      if (shouldFocusFirstNode || (targetIdx === 0 && e.shiftKey)) {\n        e.preventDefault();\n\n        const node = focusableNodes[shouldFocusFirstNode ? 0 : lastIdx];\n\n        if (node !== document!.activeElement) {\n          node.focus();\n        }\n\n        return false;\n      }\n    }\n\n    if (onClose && pressedKey(e) === Keys.ESCAPE) {\n      onClose();\n    }\n\n    return true;\n  };\n  useGlobalEventListener(document, 'keydown', onDocumentKeydown, {\n    capture: true,\n  });\n\n  return (\n    <Component tabIndex={-1} ref={ref} {...restProps}>\n      {children}\n    </Component>\n  );\n};\n"],"mappings":"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"}