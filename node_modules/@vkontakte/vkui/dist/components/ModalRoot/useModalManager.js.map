{"version":3,"file":"useModalManager.js","names":["React","ModalType","warnOnce","getNavId","useIsomorphicLayoutEffect","noop","isFunction","getModals","children","Children","toArray","warn","modalTransitionReducer","state","action","type","id","activeModal","nextModal","prevModal","exitingModal","history","isBack","Boolean","includes","splice","indexOf","push","enteringModal","useModalManager","onOpen","onOpened","onClose","onClosed","initModal","modalsState","useRef","current","forEach","Modal","modalProps","props","undefined","dynamicContentHeight","settlingHeight","isMissing","safeActiveModal","useReducer","transitionState","dispatchTransition","process","env","NODE_ENV","isCard","CARD","onEntered","useCallback","modalState","onExited","delayEnter","getModalState","onEnter","onExit","withModalManager","Wrapped","WithModalManager","transitionManager"],"sources":["../../../src/components/ModalRoot/useModalManager.tsx"],"sourcesContent":["import * as React from 'react';\nimport { ModalsState, ModalsStateEntry, ModalType } from './types';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { getNavId } from '../../lib/getNavId';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { noop, isFunction } from '@vkontakte/vkjs';\n\ninterface ModalTransitionState {\n  activeModal?: string | null;\n  enteringModal?: string | null;\n  exitingModal?: string | null;\n\n  history?: string[];\n  isBack?: boolean | null;\n}\n\nexport interface ModalTransitionProps extends ModalTransitionState {\n  onEnter: VoidFunction;\n  onEntered: (id: string | null) => void;\n  onExit: VoidFunction;\n  onExited: (id: string | null) => void;\n  getModalState: (id: string) => ModalsStateEntry;\n  delayEnter: boolean;\n}\n\nfunction getModals(children: React.ReactNode | React.ReactNode[]) {\n  return React.Children.toArray(children) as React.ReactElement[];\n}\n\nconst warn = warnOnce('ModalRoot');\n\nexport function modalTransitionReducer(\n  state: ModalTransitionState,\n  action: {\n    type: 'setActive' | 'entered' | 'exited' | 'inited';\n    id: string | null;\n  },\n): ModalTransitionState {\n  if (action.type === 'setActive' && action.id !== state.activeModal) {\n    const nextModal = action.id;\n    // preserve exiting modal if switching mid-transition\n    const prevModal = state.exitingModal || state.activeModal;\n    let history = state.history ? [...state.history] : [];\n    const isBack = Boolean(nextModal && history.includes(nextModal));\n\n    if (nextModal === null) {\n      history = [];\n    } else if (isBack) {\n      history = history.splice(0, history.indexOf(nextModal) + 1);\n    } else {\n      history.push(nextModal);\n    }\n\n    return {\n      activeModal: nextModal,\n      // not entering yet\n      enteringModal: null,\n      exitingModal: prevModal,\n      history,\n      isBack,\n    };\n  }\n  if (action.type === 'entered' && action.id === state.enteringModal) {\n    return { ...state, enteringModal: null };\n  }\n  if (action.type === 'exited' && action.id === state.exitingModal) {\n    return { ...state, exitingModal: null };\n  }\n  if (action.type === 'inited' && action.id === state.activeModal) {\n    return { ...state, enteringModal: action.id };\n  }\n  return state;\n}\n\n/**\n * Реализует переход модалок. При смене activeModal m1 -> m2:\n * 1. activeModal: m1, exitingModal: null, enteringModal: null, триггер перехода\n * 2. activeModal: m2, exitingModal: m1, enteringModal: null, рендерим m2 чтобы прошел init, начинаем анимацию выхода\n * одновременный переход между ModalPage:\n *   3a. activeModal: m2, exitingModal: m1, enteringModal: m2\n *   4a. exitingModal и enteringModal переходят в null в порядке завершения анимации\n * ИЛИ дожидаемся скрытия ModalCard\n *   3b. activeModal: m2, exitingModal: null, enteringModal: m2\n *   4b. enteringModal переходит в null после завершения анимации\n * 5. activeModal: m2, exitingModal: null, enteringModal: null, переход закончен\n */\nexport function useModalManager(\n  activeModal: string | null | undefined,\n  children: React.ReactNode | React.ReactNode[],\n  onOpen: (id: string) => void = noop,\n  onOpened: (id: string) => void = noop,\n  onClose: (id: string) => void = noop,\n  onClosed: (id: string) => void = noop,\n  initModal: (state: ModalsStateEntry) => void = noop,\n): ModalTransitionProps {\n  const modalsState = React.useRef<ModalsState>({}).current;\n  getModals(children).forEach((Modal) => {\n    const modalProps = Modal.props;\n    const id = getNavId(modalProps, warn);\n    const state: ModalsStateEntry = (id !== undefined && modalsState[id]) || {\n      id: id ?? null,\n    };\n\n    state.onOpen = Modal.props.onOpen;\n    state.onOpened = Modal.props.onOpened;\n    state.onClose = Modal.props.onClose;\n    state.onClosed = Modal.props.onClosed;\n    state.dynamicContentHeight = !!modalProps.dynamicContentHeight;\n    // ModalPage props\n    if (typeof modalProps.settlingHeight === 'number') {\n      state.settlingHeight = modalProps.settlingHeight;\n    }\n\n    if (state.id !== null) {\n      modalsState[state.id] = state;\n    }\n  });\n\n  const isMissing = activeModal && !modalsState[activeModal];\n  const safeActiveModal = isMissing ? null : activeModal;\n  const [transitionState, dispatchTransition] = React.useReducer(modalTransitionReducer, {\n    activeModal: safeActiveModal,\n    enteringModal: null,\n    exitingModal: null,\n    history: safeActiveModal ? [safeActiveModal] : [],\n    isBack: false,\n  });\n\n  // Map props to state, render activeModal for init\n  useIsomorphicLayoutEffect(() => {\n    // ignore non-existent activeModal\n    if (process.env.NODE_ENV === 'development' && isMissing) {\n      warn(`Переход невозможен - модальное окно (страница) ${activeModal} не существует`, 'error');\n    }\n    dispatchTransition({ type: 'setActive', id: safeActiveModal ?? null });\n  }, [activeModal]);\n\n  // Init activeModal & set enteringModal\n  useIsomorphicLayoutEffect(() => {\n    if (transitionState.activeModal) {\n      initModal(modalsState[transitionState.activeModal]);\n      dispatchTransition({ type: 'inited', id: transitionState.activeModal });\n    }\n  }, [transitionState.activeModal]);\n\n  const isCard = (id: string | null | undefined) =>\n    id != null && modalsState[id]?.type === ModalType.CARD;\n  const onEntered = React.useCallback(\n    (id: string | null) => {\n      if (id) {\n        const modalState = modalsState[id];\n\n        if (isFunction(modalState.onOpened)) {\n          modalState.onOpened();\n        } else if (isFunction(onOpened)) {\n          onOpened(id);\n        }\n      }\n\n      dispatchTransition({ type: 'entered', id });\n    },\n    [modalsState, onOpened],\n  );\n  const onExited = React.useCallback(\n    (id: string | null) => {\n      if (id) {\n        const modalState = modalsState[id];\n\n        if (isFunction(modalState.onClosed)) {\n          modalState.onClosed();\n        } else if (isFunction(onClosed)) {\n          onClosed(id);\n        }\n      }\n\n      dispatchTransition({ type: 'exited', id });\n    },\n    [modalsState, onClosed],\n  );\n  const delayEnter = Boolean(\n    transitionState.exitingModal && (isCard(activeModal) || isCard(transitionState.exitingModal)),\n  );\n  const getModalState = React.useCallback((id: string) => modalsState[id], [modalsState]);\n\n  function onEnter() {\n    const modalState = transitionState.activeModal && modalsState[transitionState.activeModal];\n    if (modalState) {\n      if (isFunction(modalState.onOpen)) {\n        modalState.onOpen();\n      } else if (isFunction(onOpen)) {\n        onOpen(modalState.id);\n      }\n    }\n  }\n\n  function onExit() {\n    const modalState = transitionState.activeModal && modalsState[transitionState.activeModal];\n    if (modalState) {\n      if (isFunction(modalState.onClose)) {\n        modalState.onClose();\n      } else if (isFunction(onClose)) {\n        onClose(modalState.id);\n      }\n    }\n  }\n\n  return {\n    onEnter,\n    onEntered,\n    onExit,\n    onExited,\n    ...transitionState,\n    delayEnter,\n    getModalState,\n  };\n}\n\nexport function withModalManager(initModal: (a: ModalsStateEntry) => void = noop) {\n  return function <Props extends ModalTransitionProps>(\n    Wrapped: React.ComponentType<Props>,\n  ): React.ComponentType<\n    Omit<Props, keyof ModalTransitionProps> & {\n      activeModal?: string | null;\n      children?: React.ReactNode;\n    }\n  > {\n    return function WithModalManager(props) {\n      const transitionManager = useModalManager(\n        props.activeModal,\n        props.children,\n        (props as any).onOpen,\n        (props as any).onOpened,\n        (props as any).onClose,\n        (props as any).onClosed,\n        initModal,\n      );\n      return <Wrapped {...(props as any)} {...transitionManager} />;\n    };\n  };\n}\n"],"mappings":"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"}