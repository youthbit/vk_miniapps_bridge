{"version":3,"file":"FocusTrap.js","names":["React","useExternRef","useGlobalEventListener","useTimeout","FOCUSABLE_ELEMENTS_LIST","Keys","pressedKey","useDOM","useIsomorphicLayoutEffect","AppRootContext","FOCUSABLE_ELEMENTS","join","FocusTrap","Component","onClose","restoreFocus","timeout","getRootRef","children","restProps","ref","document","window","useState","focusableNodes","setFocusableNodes","restoreFocusTo","setRestoreFocusTo","useContext","keyboardInput","focusOnTrapMount","current","contains","activeElement","length","focus","set","nodes","Array","prototype","forEach","call","querySelectorAll","focusableEl","getComputedStyle","display","visibility","push","focusOnTrapUnmount","onDocumentKeydown","e","TAB","lastIdx","targetIdx","findIndex","node","target","shouldFocusFirstNode","shiftKey","preventDefault","ESCAPE","capture"],"sources":["../../../src/components/FocusTrap/FocusTrap.tsx"],"sourcesContent":["import * as React from 'react';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport { useGlobalEventListener } from '../../hooks/useGlobalEventListener';\nimport { useTimeout } from '../../hooks/useTimeout';\nimport { FOCUSABLE_ELEMENTS_LIST, Keys, pressedKey } from '../../lib/accessibility';\nimport { useDOM } from '../../lib/dom';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { HasComponent, HasRootRef } from '../../types';\nimport { AppRootContext } from '../AppRoot/AppRootContext';\n\nconst FOCUSABLE_ELEMENTS: string = FOCUSABLE_ELEMENTS_LIST.join();\nexport interface FocusTrapProps\n  extends React.AllHTMLAttributes<HTMLElement>,\n    HasRootRef<HTMLElement>,\n    HasComponent {\n  restoreFocus?: boolean;\n  timeout?: number;\n  onClose?(): void;\n}\n\n/**\n * @see https://vkcom.github.io/VKUI/#/FocusTrap\n */\nexport const FocusTrap = ({\n  Component = 'div',\n  onClose,\n  restoreFocus = true,\n  timeout = 0,\n  getRootRef,\n  children,\n  ...restProps\n}: FocusTrapProps) => {\n  const ref = useExternRef<HTMLElement>(getRootRef);\n\n  const { document, window } = useDOM();\n\n  const [focusableNodes, setFocusableNodes] = React.useState<HTMLElement[] | null>(null);\n  const [restoreFocusTo, setRestoreFocusTo] = React.useState<HTMLElement | null>(null);\n\n  // HANDLE TRAP MOUNT\n\n  const { keyboardInput } = React.useContext(AppRootContext);\n  const focusOnTrapMount = useTimeout(() => {\n    if (\n      keyboardInput &&\n      !ref.current?.contains(document!.activeElement) &&\n      focusableNodes?.length\n    ) {\n      focusableNodes[0].focus();\n    }\n  }, timeout);\n  useIsomorphicLayoutEffect(() => {\n    focusOnTrapMount.set();\n  }, []);\n\n  // HANDLE FOCUSABLE NODES\n\n  useIsomorphicLayoutEffect(() => {\n    if (!ref.current) {\n      return;\n    }\n\n    const nodes: HTMLElement[] = [];\n    Array.prototype.forEach.call(\n      // eslint-disable-next-line no-restricted-properties\n      ref.current.querySelectorAll(FOCUSABLE_ELEMENTS),\n      (focusableEl: Element) => {\n        const { display, visibility } = window!.getComputedStyle(focusableEl);\n\n        if (display !== 'none' && visibility !== 'hidden') {\n          nodes.push(focusableEl as HTMLElement);\n        }\n      },\n    );\n\n    if (nodes.length === 0) {\n      // Чтобы фокус был хотя бы на родителе\n      nodes.push(ref.current);\n    }\n\n    setFocusableNodes(nodes);\n  }, [children]);\n\n  // HANDLE TRAP UNMOUNT\n\n  const focusOnTrapUnmount = useTimeout(() => {\n    if (restoreFocusTo) {\n      restoreFocusTo.focus();\n    }\n  }, timeout);\n  useIsomorphicLayoutEffect(() => {\n    if (restoreFocus && document!.activeElement) {\n      setRestoreFocusTo(document!.activeElement as HTMLElement);\n\n      return () => {\n        focusOnTrapUnmount.set();\n      };\n    }\n\n    return;\n  }, [restoreFocus]);\n\n  const onDocumentKeydown = (e: KeyboardEvent) => {\n    if (pressedKey(e) === Keys.TAB && focusableNodes?.length) {\n      const lastIdx = focusableNodes.length - 1;\n      const targetIdx = focusableNodes.findIndex((node) => node === e.target);\n\n      const shouldFocusFirstNode = targetIdx === -1 || (targetIdx === lastIdx && !e.shiftKey);\n\n      if (shouldFocusFirstNode || (targetIdx === 0 && e.shiftKey)) {\n        e.preventDefault();\n\n        const node = focusableNodes[shouldFocusFirstNode ? 0 : lastIdx];\n\n        if (node !== document!.activeElement) {\n          node.focus();\n        }\n\n        return false;\n      }\n    }\n\n    if (onClose && pressedKey(e) === Keys.ESCAPE) {\n      onClose();\n    }\n\n    return true;\n  };\n  useGlobalEventListener(document, 'keydown', onDocumentKeydown, {\n    capture: true,\n  });\n\n  return (\n    <Component tabIndex={-1} ref={ref} {...restProps}>\n      {children}\n    </Component>\n  );\n};\n"],"mappings":"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"}